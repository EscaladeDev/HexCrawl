
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Hex Explorer – v4.1 (tidy)</title>
<style>
  :root{color-scheme:light dark; --bg1:#0b0b0e; --bg2:#151518; --fg:#f5f6f9; --fg-dim:#9aa0a6;
        --card:#0e0e12cc; --border:#26262c; --accent:#6366f1; --ink:#fff; --danger:#ef4444; --ok:#22c55e}
  html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif;
       background:var(--bg2); color:var(--fg)}
  .container{max-width:100%;margin:0 auto;padding:20px 24px}
  @media (max-width: 1200px){ .container{padding:16px} }
  h1{margin:0 0 4px;font-size:28px;font-weight:800;letter-spacing:-0.02em}
  .sub{color:var(--fg-dim);font-size:14px;margin:0 0 16px}
  .row{display:grid;grid-template-columns:1fr;gap:16px;align-items:start}
  @media (min-width:1200px){.row{grid-template-columns:400px 1fr}}
  .card{background:rgba(18,18,22,.7);backdrop-filter:saturate(1.15) blur(6px);border:1px solid rgba(255,255,255,.06);border-radius:18px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
  .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);padding:8px 12px;border-radius:12px;background:transparent;color:inherit;cursor:pointer}
  .btn:hover{background:#1f1f23}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:var(--ink)}
  .btn.danger{border-color:var(--danger);color:var(--danger)}
  .pill{display:inline-flex;gap:0;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .pill button{border:0;background:transparent;padding:8px 12px;color:inherit;cursor:pointer}
  .pill button.active{background:var(--accent);color:var(--ink)}
  label{font-size:13px;display:block;margin-bottom:6px}
  input, select, textarea{width:100%;border:1px solid var(--border);background:transparent;color:inherit;padding:8px 10px;border-radius:12px}
  textarea{min-height:64px;resize:vertical}
  .muted{color:var(--fg-dim);font-size:12px}
  svg{max-width:100%;height:auto;display:block;touch-action: none}
  .results{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;padding-bottom:6px}
  .result{border:1px solid rgba(255,255,255,.07);border-radius:14px;padding:12px;background:rgba(255,255,255,.02)}
  .legend{display:flex;flex-wrap:wrap;gap:8px}
  .legend-item{display:inline-flex;align-items:center;gap:8px;font-size:12px;padding:6px 10px;border:1px solid rgba(255,255,255,.07);border-radius:999px;background:rgba(255,255,255,.03)}
  .swatch{width:14px;height:14px;border-radius:4px;border:1px solid var(--border)}
  .grid{display:grid;gap:10px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .rowline{display:grid;grid-template-columns:28px 1.5fr 1fr 1fr 60px 60px 32px;gap:8px;align-items:center}
  .rowline input[type="color"]{padding:0;height:36px}
  .rowline .rm{justify-self:end}
  .bar{height:6px;background:#1f1f23;border-radius:6px;overflow:hidden}
  .bar>span{display:block;height:100%;background:var(--accent)}
  .note{font-size:12px;color:var(--fg-dim)}
  .section-title{font-size:14px;font-weight:700;margin:12px 0 6px}
  .tight{margin:6px 0}

  .hdr{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
  .map-toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .badge{border:1px solid var(--border);padding:4px 8px;border-radius:999px;font-size:12px}
  .hint{font-size:12px;color:var(--fg-dim);margin-top:6px}
  .gm-line{display:grid;grid-template-columns:110px 1fr;gap:8px;margin:4px 0}
  .gm-label{color:var(--fg-dim);font-size:12px}
  .gm-value{font-size:13px}

  /* current-position highlighting */
  .current-fill{pointer-events:none}
  .current-outline{fill:none;stroke:var(--accent);stroke-width:4;opacity:.85;pointer-events:none}
  .current-pulse{fill:none;stroke:var(--accent);stroke-width:6;stroke-opacity:.4;stroke-dasharray:10 12;pointer-events:none;animation:dash 2.6s linear infinite,fade 2.6s ease-in-out infinite}
  @keyframes dash{to{stroke-dashoffset:-44}}
  @keyframes fade{0%,100%{stroke-opacity:.15}50%{stroke-opacity:.55}}

  @media (max-width: 760px){ .grid2{grid-template-columns:1fr} .row{gap:12px} }


  .dirchip{display:inline-flex;align-items:center;justify-content:center;min-width:26px;height:22px;
           padding:0 8px;border:1px solid rgba(255,255,255,.18);border-radius:999px;font-size:12px;
           background:rgba(255,255,255,.05);margin-right:8px}
  .result{transition:box-shadow .2s,border-color .2s,background .2s}
  .result:hover{box-shadow:0 8px 24px rgba(0,0,0,.25);background:rgba(255,255,255,.04)}
  .result.hot{border-color:rgba(255,255,255,.35);box-shadow:0 10px 30px rgba(0,0,0,.35);background:rgba(255,255,255,.06)}


  /* Map height tuning */
  #mapSvg{height:420px}
  @media (max-width: 1200px){ #mapSvg{height:380px} }
  @media (max-width: 900px){ #mapSvg{height:340px} }
  @media (max-width: 700px){ #mapSvg{height:300px} }


  /* toast + (optional) wide map sizing kept minimal to avoid regressions */
  .toast-wrap{position:fixed;top:14px;right:14px;z-index:10000;display:flex;flex-direction:column;gap:8px}
  .toast{background:rgba(18,18,22,.88);border:1px solid var(--border);padding:10px 12px;border-radius:12px;box-shadow:0 12px 30px rgba(0,0,0,.4)}
  .toast.danger{border-color:var(--danger);}

</style>
</head>
<body>
<div class="container">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:14px">
    <div>
      <h1 style="margin:0;font-size:26px;letter-spacing:-0.02em">Hex Explorer</h1>
      <p class="sub" style="margin:4px 0 0">Explore adjacent hexes • GM details on click</p>
    </div>
    <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
      <input id="seed" type="text" placeholder="Seed (optional)" style="min-width:160px;flex:1 1 220px"/>
      <button class="btn" id="resetView" title="Recenter on current">🔭 Reset View</button>
      <button class="btn" id="travelSelected" title="Travel to selected adjacent hex">🧭 Travel to Selected</button>
      <span class="badge" id="posBadge">at (0,0)</span>
    </div>
  </div>

  <div class="row">
    <!-- LEFT: MAP AREA -->
    <div class="card" style="grid-column: 1 / -1;">
      <div class="hdr"><h2 style="margin:0">Map</h2><div class="badge" id="selBadge">no hex selected</div></div>
      <svg id="mapSvg" viewBox="0 0 1000 700" role="img" aria-label="Hex map" style="border-radius:12px"></svg>
      <div id="cards" class="results" style="margin-top:12px"></div>
      <div class="card" style="margin-top:12px">
        <h3 style="margin:0 0 8px">GM Details</h3>
        <div id="gmDetail" class="muted">Click a discovered hex to see expanded prompts and tables.</div>
      </div>

    </div>

    <!-- CONTROLS under map -->
    <div class="card" style="grid-column: 1 / -1;">
      <h2 style="margin:0 0 10px">Controls</h2>
      <div class="grid">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
          <label>Rolling Mode</label>
          <div class="pill">
            <button class="active" data-mode="d20">d20 Table</button>
            <button data-mode="weighted">Weighted</button>
          </div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
          <label>Fog of War</label>
          <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
            <label class="tight"><input id="fogEnabled" type="checkbox"/> Enable</label>
            <div style="display:flex;align-items:center;gap:6px">
              <span class="muted" style="font-size:12px">Chance</span>
              <input id="fogChance" type="range" min="0" max="100" step="1" value="35" style="width:160px"/>
              <span id="fogPct" class="muted" style="min-width:36px;text-align:right">35%</span>
            </div>
          </div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
          <label>Patrols</label>
          <div style="display:flex;align-items:center;gap:14px;flex-wrap:wrap">
            <label class="tight"><input id="patrolsEnabled" type="checkbox"/> Enable</label>
            <div style="display:flex;align-items:center;gap:6px">
              <span class="muted" style="font-size:12px">Spawn</span>
              <input id="patrolSpawn" type="range" min="0" max="100" step="1" value="20" style="width:140px"/>
              <span id="patrolSpawnPct" class="muted" style="min-width:36px;text-align:right">20%</span>
            </div>
            <div style="display:flex;align-items:center;gap:6px">
              <span class="muted" style="font-size:12px">Move</span>
              <input id="patrolMove" type="range" min="0" max="100" step="1" value="35" style="width:140px"/>
              <span id="patrolMovePct" class="muted" style="min-width:36px;text-align:right">35%</span>
            </div>
          </div>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
          <label>Visibility</label>
          <div class="pill">
            <button data-visibility="disadv">Disadv</button>
            <button class="active" data-visibility="normal">Normal</button>
            <button data-visibility="adv">Adv</button>
          </div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
          <label>Orientation (fixed)</label>
          <div class="pill">
            <button class="active" data-orient="pointy">Pointy-top</button>
          </div>
        </div>

        <div class="grid2">
          <div>
            <label for="seed">Seed (optional)</label>
            <input id="seed" type="text" placeholder="e.g. session-12, map-A"/>
          </div>
        </div>
        <label class="tight"><input id="clarity" type="checkbox" checked/> Include Clarity (& Secondary on 6)</label>
        <label class="tight"><input id="wherein" type="checkbox" checked/> Include Where-in-Hex</label>

        <div>
          <button class="btn" id="clearRing">🧹 Clear Ring Cards</button>
        </div>
        <p class="muted">Tip: High vantage = roll twice, pick one. Dense canopy/night = roll twice, take lower.</p>
      </div>

      <h3 class="section-title">Config</h3>
      <div class="grid2">
        <button class="btn" id="loadBtn">📥 Load JSON</button>
        <button class="btn" id="saveBtn">💾 Save JSON</button>
      </div>
      <input id="fileInput" type="file" accept="application/json" style="display:none"/>
      <button class="btn" id="resetBtn" style="margin-top:8px">⤴︎ Reset Options to Defaults</button>
      <button class="btn danger" id="hardReset" style="margin-top:8px">🧨 Hard Reset (clear cache)</button>
      <p class="note">Saving downloads <code>hex-visualizer-config.json</code>. Keep it next to this HTML and use “Load JSON” later.</p>

      <h3 class="section-title">Legend</h3>
      <div id="legend" class="legend"></div>
    </div>

    <div class="card" style="grid-column: 1 / -1;">
<h2 style="margin:16px 0 10px">Options & Weights</h2>
      <div class="note" style="margin-bottom:8px">Weights are relative. Chances are normalized and shown live.</div>

      <div class="rowline muted" style="font-weight:700">
        <div>#</div><div>Label</div><div>Icon</div><div>Color</div><div>Weight</div><div>Chance</div><div></div>
      </div>
      <div id="optList"></div>

      <details style="margin-top:10px">
        <summary class="btn" style="display:inline-flex">➕ Add option</summary>
        <div class="grid2" style="margin-top:8px">
          <div>
            <label>Label</label>
            <input id="newLabel" placeholder="e.g. Ruin"/>
          </div>
          <div>
            <label>Icon (emoji)</label>
            <input id="newIcon" placeholder="🏚️"/>
          </div>
          <div>
            <label>Color</label>
            <input id="newColor" type="color" value="#7c3aed"/>
          </div>
          <div>
            <label>Weight</label>
            <input id="newWeight" type="number" min="0" step="0.1" value="1"/>
          </div>
          <div style="grid-column: 1 / -1">
            <label>Description (what you see)</label>
            <textarea id="newDesc" placeholder="e.g. Ruin outline: arch, menhir ring, toppled tower, old wall line."></textarea>
          </div>
        </div>
        <button class="btn primary" id="addOption" style="margin-top:8px">Add</button>
      </details>
</div>
    </div>
  </div>
</div>


<div id="toasts" class="toast-wrap" aria-live="polite"></div>

<script src="hex-explorer.js"></script>
</body>
</html>
